<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    :root { --primary:#ffaa0d; --muted:#666; }
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; color:#111; }
    h1,h2 { margin: 8px 0 6px; }
    input, button, select, textarea {
      margin: 5px 0; padding: 10px; font-size: 1rem; width: 100%; box-sizing: border-box;
      border:1px solid #e5e7eb; border-radius:10px; background:#fff;
    }
    button { cursor: pointer; background:#111; color:#fff; }
    button.primary { background: var(--primary); color:#111; border:none; }
    .row { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .card  { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px; margin:12px 0; box-shadow:0 8px 18px rgba(0,0,0,.06); }
    .menu-card { border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:10px; background:#fff; }
    .muted { color: var(--muted); font-size: .9rem; }
    img { max-width: 150px; display: block; margin-top: 5px; border-radius:10px; }
    label.inline { display:flex; align-items:center; gap:8px; }
    .grid { display:grid; gap:10px; }
  </style>
</head>
<body>

  <h1>Admin Dashboard</h1>

  <!-- ฟอร์มเพิ่มร้านอาหาร -->
  <div class="card">
    <h2>เพิ่มร้านอาหาร</h2>
    <div class="row">
      <div><input id="restaurantName" placeholder="ชื่อร้าน" /></div>
      <div><input id="restaurantImage" placeholder="URL รูปภาพร้าน" /></div>
      <div><input id="restaurantLat" placeholder="ละติจูด (Latitude)" /></div>
      <div><input id="restaurantLng" placeholder="ลองจิจูด (Longitude)" /></div>
      <div><input id="restaurantAddress" placeholder="ที่อยู่ (ไม่บังคับ)" /></div>
      <div><input id="restaurantPhone" placeholder="เบอร์โทร (ไม่บังคับ)" /></div>
    </div>
    <button class="primary" onclick="addRestaurant()">เพิ่มร้านอาหาร</button>
    <div class="muted">หมายเหตุ: ระบบจะสร้างพิกัด GeoJSON จากค่า lng/lat ให้โดยอัตโนมัติ</div>
  </div>

  <!-- ฟอร์มเพิ่มเมนู -->
  <div class="card">
    <h2>เพิ่มเมนูอาหาร</h2>
    <div class="row">
      <div>
        <select id="restaurantSelect">
          <option value="">-- เลือกร้านอาหาร --</option>
        </select>
      </div>
      <div><input id="menuName" placeholder="ชื่อเมนู" /></div>
      <div><input id="menuPrice" type="number" placeholder="ราคา" /></div>
      <div><input id="menuType" placeholder="ประเภท" /></div>
      <div><input id="menuImage" placeholder="URL รูปภาพเมนู" /></div>
    </div>
    <textarea id="menuDescription" placeholder="รายละเอียดเมนู"></textarea>


    <button class="primary" onclick="addMenu()">เพิ่มเมนู</button>
    <div class="muted">คำแนะนำ: เมนูที่ติ๊ก <code>isFeatured</code> และตั้ง <code>featuredBoost</code> จะมีคะแนนสูงขึ้นใน “ยอดฮิต”</div>
  </div>
  <!-- แสดงรายการเมนูทั้งหมด -->
  <div class="card">
    <h2>รายการเมนูทั้งหมด</h2>
    <div id="menuList"></div>
  </div>

<script>
  // === Utils ===
  const jfetch = async (url, opts={}) => {
    const res = await fetch(url, opts);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) { throw new Error(data?.error || data?.message || ('HTTP '+res.status)); }
    return data;
  };
  const clear = (ids) => ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

  // โหลดตัวเลือกร้านอาหาร
  async function loadRestaurantOptions() {
    try {
      const data = await jfetch('/api/restaurants');
      const select = document.getElementById('restaurantSelect');
      select.innerHTML = '<option value="">-- เลือกร้านอาหาร --</option>';
      data.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r._id;
        opt.textContent = r.name;
        select.appendChild(opt);
      });
    } catch (error) {
      alert('โหลดร้านอาหารล้มเหลว: ' + error.message);
    }
  }

  // เพิ่มร้านอาหาร (ใช้ lng/lat ตรงตาม API)
  async function addRestaurant() {
    const name = document.getElementById('restaurantName').value.trim();
    const image = document.getElementById('restaurantImage').value.trim();
    const lat = parseFloat(document.getElementById('restaurantLat').value);
    const lng = parseFloat(document.getElementById('restaurantLng').value);
    const address = document.getElementById('restaurantAddress').value.trim();
    const phone = document.getElementById('restaurantPhone').value.trim();

    if (!name || isNaN(lat) || isNaN(lng)) {
      alert('กรุณากรอกชื่อร้าน + พิกัดให้ถูกต้อง');
      return;
    }
    try {
      const payload = { name, image, address, phone, lat, lng };
      await jfetch('/api/restaurants', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      alert('เพิ่มร้านอาหารเรียบร้อยแล้ว');
      clear(['restaurantName','restaurantImage','restaurantLat','restaurantLng','restaurantAddress','restaurantPhone']);
      await loadRestaurantOptions();
    } catch (error) {
      alert('เกิดข้อผิดพลาด: ' + error.message);
    }
  }

  // เพิ่มเมนูอาหาร (ตัด status ออก เหลือ isFeatured/featuredBoost)
  async function addMenu() {
    const name = document.getElementById('menuName').value.trim();
    const price = parseFloat(document.getElementById('menuPrice').value);
    const type = document.getElementById('menuType').value.trim();
    const image = document.getElementById('menuImage').value.trim();
    const description = document.getElementById('menuDescription').value.trim();
    const restaurantId = document.getElementById('restaurantSelect').value;

    const isFeatured = document.getElementById('menuIsFeatured').checked;
    const featuredBoost = parseInt(document.getElementById('menuFeaturedBoost').value || '0', 10);

    if (!name || isNaN(price) || !type || !restaurantId) {
      alert('กรุณากรอกชื่อเมนู/ราคา/ประเภท/เลือกร้าน');
      return;
    }

    try {
      const payload = { name, price, type, image, description, restaurantId, isFeatured, featuredBoost };
      await jfetch('/api/menus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      alert('เพิ่มเมนูอาหารเรียบร้อยแล้ว');
      clear(['menuName','menuPrice','menuType','menuImage','menuDescription','menuFeaturedBoost']);
      document.getElementById('menuIsFeatured').checked = false;
      await loadMenus();
    } catch (error) {
      alert('เกิดข้อผิดพลาด: ' + error.message);
    }
  }

  // อัปเดตบูสต์ของเมนู (PATCH) — ไม่ยุ่งกับ status
  async function updateMenuFlags() {
    const id = document.getElementById('editMenuId').value.trim();
    const isFeatured = document.getElementById('editFeatured').checked;
    const featuredBoost = parseInt(document.getElementById('editBoost').value || '0', 10);

    if (!id) { alert('กรอก menuId'); return; }
    try {
      const body = { isFeatured, featuredBoost };
      await jfetch('/api/menus/' + encodeURIComponent(id), {
        method: 'PATCH',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      alert('อัปเดตสำเร็จ');
      await loadMenus();
    } catch (error) {
      alert('อัปเดตไม่สำเร็จ: ' + error.message);
    }
  }

  // โหลดเมนูทั้งหมด (ไม่แสดง status แล้ว)
  async function loadMenus() {
    try {
      const menus = await jfetch('/api/menus');
      const container = document.getElementById('menuList');
      container.innerHTML = '';

      menus.forEach(menu => {
        const div = document.createElement('div');
        div.className = 'menu-card';
        div.innerHTML = `
          <p><strong>${menu.name}</strong> (${menu.type || '-'}) - ${menu.price ?? '-'} บาท</p>
          <p>รายละเอียด: ${menu.description || 'ไม่มีรายละเอียด'}</p>
          <p class="muted">isFeatured: <b>${menu.isFeatured ? 'true' : 'false'}</b> • featuredBoost: <b>${menu.featuredBoost || 0}</b></p>
          <img src="${menu.image || ''}" alt="รูปเมนู: ${menu.name}" />
          <p>ร้าน: ${menu.restaurant?.name || 'ไม่ระบุร้าน'}</p>
          ${menu.restaurant?.image ? `<img src="${menu.restaurant.image}" alt="รูปของร้าน: ${menu.restaurant.name}" />` : ''}
        `;
        container.appendChild(div);
      });
    } catch (error) {
      alert('โหลดเมนูล้มเหลว: ' + error.message);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadRestaurantOptions();
    loadMenus();
  });
</script>

</body>
</html>